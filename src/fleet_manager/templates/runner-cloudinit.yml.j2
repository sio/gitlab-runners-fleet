#cloud-config

package_update: true
packages:
  - coreutils
  - curl
  - git
  - make
  - python3-apt
  - python3-venv
  - sudo

users:
  - name: root
    lock_passwd: false
    plain_text_passwd: devpswd1  # TODO: remove insecure password

write_files:
  - owner: root:root
    permissions: '0600'
    path: /etc/provision/public_key
    content: |-
      {{ static_file(public_key)|indent(6) }}
  - owner: root:root
    permissions: '0600'
    path: /etc/provision/gitlab_runner_token
    content: |-
      {{ gitlab_runner_token|indent(6) }}
{% for filename in (
        'Makefile',
        'metrics.py',
        'metrics.service',
        'requirements.txt',
        'requirements.yml',
        'runner-playbook.yml',
) %}
  - owner: root:root
    permissions: '0600'
    path: /etc/provision/{{ filename }}
    content: |-
      {{ static_file(filename)|indent(6) }}
{% endfor %}

runcmd:
  - /usr/bin/make -C /etc/provision/ >> /etc/provision/log && touch /etc/provision/completed

bootcmd:
  - |
    echo 'Waiting for Internet connection...'
    REMOTE_IP=8.8.8.8
    timeout 10m sh <<EOF
        while true
        do
            ping -c1 -w1 "$REMOTE_IP" && break
        done
    EOF
